<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8" />
	<title>RightPatient: #2 ID</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="css/normalize.min.css">
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="css/bootstrap-select.min.css">
	<link href="css/style.css" rel="stylesheet" />
</head>

<body>
	<div class="wrapper my-4 text-center">
		<div class="container">
			<div class="row">
				<div class="col-md-12">
					<form id="fileForm" enctype="multipart/form-data" method="POST">
						<!-- step 2 start -->
						<div id="step2" class="inner-wrap shadow-sm py-5 px-3">
							<img class="img-fluid company-logo mb-5" src="img/baptist-logo.png">
							
							<div id="step2-wrapper">
								<h2 class="hello mb-3">Take a photo of your ID card</h2>
								<div class="time-msg mb-3">A photo of your ID card is required to validate your identity</div>
								<div class="identity-dropdown shadow-sm mb-4">
									<select id="mySelect" data-show-content="true" class="form-control border">
										<option value="DriverLicense" data-content="<i class='fa fa-address-card-o'></i> Driver's License"> Driver's License</option>
										<option value="NationalID" data-content="<i class='fa fa-address-card-o'></i> National ID"> National ID</option>
										<option value="Passport" data-content="<i class='fa fa-address-card-o'></i> Passport"> Passport</option>										
										<option value="InsuranceID" data-content="<i class='fa fa-id-card-o'></i> Insurance ID"> Insurance ID</option>
									</select>
								</div>
								<div class="overflow-hidden">
									<div class="float-left width-49">
										<div id="mobileCamera" class="mb-15"><input id="frontFile" class="mobileImg mobileImgId" type="file" name="image" accept="image/*" capture="camera"></div>
										<div id="mobileThumb" class="thumb-wrapper">
											<button id="cBtnId" class="mcancelBtn">x</button><img id="thumbnil" src="" alt="" />
											<input type="hidden" name="tfHidden" id="tfHidden" value="">
											<canvas width="500" height="300" id="PhotoEditF" style="width: 100%;">
												<p>
													<font color="white">This browser does not support the required features. Please try
													<a href="http://windows.microsoft.com/en-us/internet-explorer/products/ie/home">Internet Explorer 10</a>,
													or a current version of
													<a href="http://www.mozilla.org/en-US/firefox/new/">Firefox</a>,
													<a href="http://www.google.com/chrome">Chrome</a>, or
													<a href="http://www.apple.com/safari/">Safari</a>.</font>
												</p>
											</canvas>
										</div>
										<div class="camBtnImgWrap">
											<button id="cancelBtnId" class="cancelBtn">x</button>
											<div class="btn-img-wrap-capture">
												<span class="shadow-sm id-capture selfie-zone pt-4 pb-3" id="webCameraBtn" onClick="takePhoto('front')">
													<img class="img-fluid" src="img/id-info.png">
													<p class="pt-3 mb-0">Tap to capture</p>
												</span>
												<div class="strip"></div>
											</div>
										</div>
										<p class="front-back mb-0 mt-10">FRONT</p>
									</div>
									<div class="float-right width-49 mb-15">
										<div id="mobileCameraBack" class="mb-15"><input id="backFile" class="mobileImg mobileImgId" type="file" name="image" accept="image/*" capture="camera"></div>
										<div id="mobileThumbBack" class="thumb-wrapper">
											<button id="cbBtnId" class="mcancelBtn">x</button><img id="thumbnilBack" src="" alt="" />
											<input type="hidden" name="tbHidden" id="tbHidden" value="">
											<canvas width="500" height="300" id="PhotoEditB" style="width: 100%;">
												<p>
													<font color="white">This browser does not support the required features. Please try
													<a href="http://windows.microsoft.com/en-us/internet-explorer/products/ie/home">Internet Explorer 10</a>,
													or a current version of
													<a href="http://www.mozilla.org/en-US/firefox/new/">Firefox</a>,
													<a href="http://www.google.com/chrome">Chrome</a>, or
													<a href="http://www.apple.com/safari/">Safari</a>.</font>
												</p>
											</canvas>
										</div>
										<div class="camBtnImgWrap">
											<button id="cancelBtnIdBack" class="cancelBtn">x</button>
											<div class="btn-img-wrap-capture">
												<span class="shadow-sm id-capture selfie-zone pt-4 pb-3" id="webCameraBtnBack"
													onClick="takePhoto('back')">
													<img class="img-fluid" src="img/id-info.png">
													<p class="pt-3 mb-0">Tap to capture</p>
												</span>
												<div class="stripBack"></div>
											</div>
										</div>
										<p class="front-back mb-0 mt-10">BACK</p>
									</div>
								</div>
							</div>							

							<div id="step3-wrapper">
								<h2 class="hello mb-3">Take a selfie</h2>
								<div class="time-msg mb-3">Your selfie is required to matched with your photo ID card</div>
								<div class="overflow-hidden">
									<div class="my-3">
										<div id="mobileCamera-step3" class="mb-15"><input id="selfiImg" class="mobileImg" type="file" name="image" accept="image/*" capture="camera"></div>
										<div id="mobileThumb-step3" class="thumb-wrapper">
											<a href="#" id="cancelBtnId3-mobile" class="cancelBtn-mobile">x</a><img id="thumbnil-step3" src="" alt="" />
											<input type="hidden" name="tsHidden" id="tsHidden" value="">
											<canvas width="500" height="300" id="PhotoEditS" style="width: 100%;">
												<p>
													<font color="white">This browser does not support the required features. Please try
													<a href="http://windows.microsoft.com/en-us/internet-explorer/products/ie/home">Internet Explorer 10</a>,
													or a current version of
													<a href="http://www.mozilla.org/en-US/firefox/new/">Firefox</a>,
													<a href="http://www.google.com/chrome">Chrome</a>, or
													<a href="http://www.apple.com/safari/">Safari</a>.</font>
												</p>
											</canvas>
										</div>
										<div id="camBtnImgWrap-step3" class="camBtnImgWrap">
											<button id="cancelBtnId3" class="cancelBtn">x</button>
											<div class="btn-img-wrap">
												<span class="shadow selfie-zone py-5" id="webCameraBtn3" onClick="takePhoto('step3')">
													<img class="img-fluid" src="img/icon-selfie.png">
													<p class="pt-3 mb-0">Tap to capture</p>
												</span>
												<div class="strip-step3"></div>
											</div>
										</div>
										
									</div>
								</div>
							</div>

							<div class="pc-camera mt-4">
								<video style="width: 100%;" id="webCamera" autoplay playsinline class="handsome"></video>
								<canvas style="display: none;" class="paint"></canvas>
							</div>

							<div class="my-5 continue-btn-wrapper">
								<a id="continueLink" class="continue-link" href="#">Next</a>
								<div id="continue-loader-wrapper">
									<span id="continue-loader-message" class="red-color"></span>
								</div>
							</div>
							<div class="my-5 submit-btn-wrapper">
								<button type="submit" id="submitBtn" class="continue-link">Submit</button>
								<div id="loader-wrapper">
									<span id="loader-message" class="red-color"></span>
								</div>
							</div>
							<div class="powered-by"><span>Powered by</span> <img src="img/rightpatient-logo.png" width="100" class="img-fluid" alt="RightPatient&reg;"></div>
						</div>
						
					</form>
				</div>
			</div>
		</div>
	</div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="js/bootstrap.bundle.min.js"></script>
	<script src="js/bootstrap-select.min.js"></script>
	<script type="text/javascript" src="js/exif.js"></script>
	<script type="text/javascript" src="js/binaryajax.js"></script>
	<script>
		// Wrapper around MPL-licensed http://www.nihilogic.dk/labs/binaryajax/binaryajax.js
		// to support JavaScript typed arrays since binary strings are not supported in IE 10
		var createBinaryFile = function(uintArray) {
			var data = new Uint8Array(uintArray);
			var file = new BinaryFile(data);

			file.getByteAt = function(iOffset) {
				return data[iOffset];
			};

			file.getBytesAt = function(iOffset, iLength) {
				var aBytes = [];
				for (var i = 0; i < iLength; i++) {
					aBytes[i] = data[iOffset  + i];
				}
				return aBytes;
			};

			file.getLength = function() {
				return data.length;
			};

			return file;
		};

		if (navigator.userAgent.match(/Android/i)
			|| navigator.userAgent.match(/webOS/i)
			|| navigator.userAgent.match(/iPhone/i)
			|| navigator.userAgent.match(/iPad/i)
			|| navigator.userAgent.match(/iPod/i)
			|| navigator.userAgent.match(/BlackBerry/i)
			|| navigator.userAgent.match(/Windows Phone/i)
		) { // MOBILE 
			// return true;
			document.getElementById('webCamera').style = 'display:none';
			document.getElementById('webCameraBtn').style = 'display:none';
			document.getElementById('webCameraBtnBack').style = 'display:none';
			document.getElementById('camBtnImgWrap-step3').style = 'display:none';

			function showMyImage(fileInput, lens) {
				var files = fileInput.files;
				for (var i = 0; i < files.length; i++) {
					var file = files[i];
					var imageType = /image.*/;
					if (!file.type.match(imageType)) {
						continue;
					}
					if ( lens == 'front' ) {
						var img = document.getElementById("thumbnil");
					}
					else if ( lens == 'front-step3' ) {
						var img = document.getElementById("thumbnil-step3");
					}
					else {
						var img = document.getElementById("thumbnilBack");
					}
					img.file = file;

					var reader = new FileReader();
					reader.onload = (function (aImg) {
						return function (e) {
							
						};
					})(img);
					reader.readAsDataURL(file);
				}
			}
		}
		else { // DESKTOP
			document.getElementById('mobileCamera').style = 'display:none';
			document.getElementById('mobileThumb').style = 'display:none';
			document.getElementById('mobileCameraBack').style = 'display:none';
			document.getElementById('mobileThumbBack').style = 'display:none';
			document.getElementById('mobileCamera-step3').style = 'display:none';

			const video = document.querySelector('.handsome');
			const canvas = document.querySelector('.paint');
			const ctx = canvas.getContext('2d');
			strip = document.querySelector('.strip');
			stripstep3 = document.querySelector('.strip-step3');

			async function go() {
				// first ask for get user media
				const stream = await navigator.mediaDevices.getUserMedia({ video: true });
				video.srcObject = stream;
			}

			function takePhoto(lens) {
				console.log('takephoto');
				if (  lens == 'front' ) {
					strip = document.querySelector('.strip');
					document.getElementById('cancelBtnId').style.display = 'block';
				}
				else if ( lens == 'back' ) {
					strip = document.querySelector('.stripBack');
					document.getElementById('cancelBtnIdBack').style.display = 'block'; 
				}
				else {
					strip = document.querySelector('.strip-step3');
					document.getElementById('cancelBtnId3').style.display = 'block'; 
					document.getElementById('webCamera').style.display = 'none';
				}

				canvas.width = video.videoWidth;
				canvas.height = video.videoHeight;

				ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
				const data = canvas.toDataURL('image/png');
				const dataURI = canvas.toDataURL('image/png');
				const link = document.createElement('a');
				
				var ImageURL = '';
				if ( lens == 'front' ) {
					link.setAttribute('href', data);
					link.setAttribute('download', 'frontID');					
					link.setAttribute('id', 'frontID');	
					link.innerHTML = `<img src="${data}" alt="Picture Taken" width="100%" height="100%" id="img1" />`;

					sessionStorage.setItem("frontFileb64", data);
				}
				else if ( lens == 'back' ) {
					link.setAttribute('href', data);
					link.setAttribute('download', 'backID');
					link.setAttribute('id', 'backID');
					link.innerHTML = `<img src="${data}" alt="Picture Taken" width="100%" height="100%" id="img2" />`;
					
					sessionStorage.setItem("backFileb64", data);
				}
				else {
					link.setAttribute('href', data);
					link.setAttribute('download', 'step3');
					link.setAttribute('id', 'step3ID');
					link.innerHTML = `<img src="${data}" alt="Picture Taken" width="100%" height="100%" id="img3" />`;
					
					sessionStorage.setItem("selfieFileb64", data);
				}
				strip.insertBefore(link, strip.firsChild);
			}
		}
	</script>
	<script>
		$(function() {
			$('#PhotoEditF').hide();
			$('#PhotoEditB').hide();
			$('#PhotoEditS').hide();
			// imageFlag initial
			// imageFlag = true;
			//Init view
			$('#step3-wrapper').hide();
			$('#mySelect').selectpicker();
			$("button#cancelBtnId, button#cancelBtnIdBack, button#cancelBtnId3, a#cancelBtnId3-mobile, #cBtnId, #cbBtnId").hide();
			$(".submit-btn-wrapper").hide();
			//Init view

			$("button#cancelBtnId").click(function(e) {
				e.preventDefault();
				$(".strip a").remove();
				$(this).hide();
				$("#webCamera").show();
			});

			$("button#cBtnId").click(function(e) {
				e.preventDefault();
				$("#thumbnil").attr('src', '');
				$(this).hide();
			});
			
			$("button#cancelBtnIdBack").click(function(e) {
				e.preventDefault();
				$(".stripBack a").remove();
				$(this).hide();
				$("#webCamera").show();
			});

			$("button#cbBtnId").click(function(e) {
				e.preventDefault();
				$("#thumbnilBack").attr('src', '');
				$(this).hide();
			});

			$("button#cancelBtnId3").click(function(e) {
				e.preventDefault();
				$(".strip-step3 a").remove();
				$(this).hide();
				$("#webCamera").show();
			});

			$("a#cancelBtnId3-mobile").click(function() {
				$("#thumbnil-step3").attr('src', '');
				$(this).hide();
			});
			
			$('#frontFile').on('change', function(e) {
				e.preventDefault();
				if(this.files.length === 0) return;
				var imageFile = this.files[0];
				var img = new Image();
				var url = window.URL ? window.URL : window.webkitURL;
				img.src = url.createObjectURL(imageFile);
				img.onload = function(e) {
					url.revokeObjectURL(this.src);

					var width;
					var height;
					var binaryReader = new FileReader();
					binaryReader.onloadend=function(d) {
					console.log('binaryReader.onloadend');
						// store this base64 = d.target.result to a input hidden
						$('#tfHidden').val('data:image/png;base64,'+_arrayBufferToBase64(d.target.result));
						var exif, transform = "none";
						exif=EXIF.readFromBinaryFile(createBinaryFile(d.target.result));

						if(exif.Orientation === 8) {
							width = img.height;
							height = img.width;
							transform = "left";
						} else if(exif.Orientation === 6) {
							width = img.height;
							height = img.width;
							transform = "right";
						} else if(exif.Orientation === 1) {
							width = img.width;
							height = img.height;
						} else if(exif.Orientation === 3) {
							width = img.width;
							height = img.height;
							transform = "flip";
						} else {
							width = img.width;
							height = img.height;
						}
						var MAX_WIDTH = 700;
						var MAX_HEIGHT = 600;
						if (width/MAX_WIDTH > height/MAX_HEIGHT) {
							if (width > MAX_WIDTH) {
								height *= MAX_WIDTH / width;
								width = MAX_WIDTH;
							}
						} else {
							if (height > MAX_HEIGHT) {
								width *= MAX_HEIGHT / height;
								height = MAX_HEIGHT;
							}
						}
						$('#PhotoEditF').show();
						var canvas = $('#PhotoEditF')[0];
						canvas.width = width;
						canvas.height = height;
						var ctx = canvas.getContext("2d");
						ctx.fillStyle = 'white';
						ctx.fillRect(0, 0, canvas.width, canvas.height);
						if(transform === 'left') {
							ctx.setTransform(0, -1, 1, 0, 0, height);
							ctx.drawImage(img, 0, 0, height, width);
						} else if(transform === 'right') {
							ctx.setTransform(0, 1, -1, 0, width, 0);
							ctx.drawImage(img, 0, 0, height, width);
						} else if(transform === 'flip') {
							ctx.setTransform(1, 0, 0, -1, 0, height);
							ctx.drawImage(img, 0, 0, width, height);
						} else {
							ctx.setTransform(1, 0, 0, 1, 0, 0);
							ctx.drawImage(img, 0, 0, width, height);
						}
						ctx.setTransform(1, 0, 0, 1, 0, 0);
						
						var image = convertCanvasToImage(canvas);
						$('#thumbnil').attr('src', image.src);
						$('#PhotoEditF').hide();
						$("button#cBtnId").show();
					};
					binaryReader.readAsArrayBuffer(imageFile);
				};
			});
			
			$('#backFile').on('change', function(e) {
				e.preventDefault();
				if(this.files.length === 0) return;
				var imageFile = this.files[0];
				var img = new Image();
				var url = window.URL ? window.URL : window.webkitURL;
				img.src = url.createObjectURL(imageFile);
				img.onload = function(e) {
					url.revokeObjectURL(this.src);

					var width;
					var height;
					var binaryReader = new FileReader();
					binaryReader.onloadend=function(d) {
					console.log('binaryReader.onloadend');
						// store this base64 = d.target.result to a input hidden
						$('#tbHidden').val('data:image/png;base64,'+_arrayBufferToBase64(d.target.result));
						var exif, transform = "none";
						exif=EXIF.readFromBinaryFile(createBinaryFile(d.target.result));

						if(exif.Orientation === 8) {
							width = img.height;
							height = img.width;
							transform = "left";
						} else if(exif.Orientation === 6) {
							width = img.height;
							height = img.width;
							transform = "right";
						} else if(exif.Orientation === 1) {
							width = img.width;
							height = img.height;
						} else if(exif.Orientation === 3) {
							width = img.width;
							height = img.height;
							transform = "flip";
						} else {
							width = img.width;
							height = img.height;
						}
						var MAX_WIDTH = 700;
						var MAX_HEIGHT = 600;
						if (width/MAX_WIDTH > height/MAX_HEIGHT) {
							if (width > MAX_WIDTH) {
								height *= MAX_WIDTH / width;
								width = MAX_WIDTH;
							}
						} else {
							if (height > MAX_HEIGHT) {
								width *= MAX_HEIGHT / height;
								height = MAX_HEIGHT;
							}
						}
						$('#PhotoEditB').show();
						var canvas = $('#PhotoEditB')[0];
						canvas.width = width;
						canvas.height = height;
						var ctx = canvas.getContext("2d");
						ctx.fillStyle = 'white';
						ctx.fillRect(0, 0, canvas.width, canvas.height);
						if(transform === 'left') {
							ctx.setTransform(0, -1, 1, 0, 0, height);
							ctx.drawImage(img, 0, 0, height, width);
						} else if(transform === 'right') {
							ctx.setTransform(0, 1, -1, 0, width, 0);
							ctx.drawImage(img, 0, 0, height, width);
						} else if(transform === 'flip') {
							ctx.setTransform(1, 0, 0, -1, 0, height);
							ctx.drawImage(img, 0, 0, width, height);
						} else {
							ctx.setTransform(1, 0, 0, 1, 0, 0);
							ctx.drawImage(img, 0, 0, width, height);
						}
						ctx.setTransform(1, 0, 0, 1, 0, 0);
						var image = convertCanvasToImage(canvas);
						$('#thumbnilBack').attr('src', image.src);
						$('#PhotoEditB').hide();
						$("button#cbBtnId").show();
					};
					binaryReader.readAsArrayBuffer(imageFile);
				};
			});
			
			$('#selfiImg').on('change', function(e) {
				e.preventDefault();
				if(this.files.length === 0) return;
				var imageFile = this.files[0];
				var img = new Image();
				var url = window.URL ? window.URL : window.webkitURL;
				img.src = url.createObjectURL(imageFile);
				img.onload = function(e) {
					url.revokeObjectURL(this.src);

					var width;
					var height;
					var binaryReader = new FileReader();
					binaryReader.onloadend=function(d) {
					console.log('binaryReader.onloadend');
						// store this base64 = d.target.result to a input hidden
						$('#tsHidden').val('data:image/png;base64,'+_arrayBufferToBase64(d.target.result));
						var exif, transform = "none";
						exif=EXIF.readFromBinaryFile(createBinaryFile(d.target.result));

						if(exif.Orientation === 8) {
							width = img.height;
							height = img.width;
							transform = "left";
						} else if(exif.Orientation === 6) {
							width = img.height;
							height = img.width;
							transform = "right";
						} else if(exif.Orientation === 1) {
							width = img.width;
							height = img.height;
						} else if(exif.Orientation === 3) {
							width = img.width;
							height = img.height;
							transform = "flip";
						} else {
							width = img.width;
							height = img.height;
						}
						var MAX_WIDTH = 700;
						var MAX_HEIGHT = 600;
						if (width/MAX_WIDTH > height/MAX_HEIGHT) {
							if (width > MAX_WIDTH) {
								height *= MAX_WIDTH / width;
								width = MAX_WIDTH;
							}
						} else {
							if (height > MAX_HEIGHT) {
								width *= MAX_HEIGHT / height;
								height = MAX_HEIGHT;
							}
						}
						$('#PhotoEditS').show();
						var canvas = $('#PhotoEditS')[0];
						canvas.width = width;
						canvas.height = height;
						var ctx = canvas.getContext("2d");
						ctx.fillStyle = 'white';
						ctx.fillRect(0, 0, canvas.width, canvas.height);
						if(transform === 'left') {
							ctx.setTransform(0, -1, 1, 0, 0, height);
							ctx.drawImage(img, 0, 0, height, width);
						} else if(transform === 'right') {
							ctx.setTransform(0, 1, -1, 0, width, 0);
							ctx.drawImage(img, 0, 0, height, width);
						} else if(transform === 'flip') {
							ctx.setTransform(1, 0, 0, -1, 0, height);
							ctx.drawImage(img, 0, 0, width, height);
						} else {
							ctx.setTransform(1, 0, 0, 1, 0, 0);
							ctx.drawImage(img, 0, 0, width, height);
						}
						ctx.setTransform(1, 0, 0, 1, 0, 0);
						var image = convertCanvasToImage(canvas);
						$('#thumbnil-step3').attr('src', image.src);
						$('#PhotoEditS').hide();
						$("a#cancelBtnId3-mobile").show();
					};
					binaryReader.readAsArrayBuffer(imageFile);
				};
			});

			$('#continueLink').click(function(e) {
				e.preventDefault();
				if ( $('.strip').html() == "" && $("#mobileCamera").css("display") == "none" ) {
					$('#continue-loader-wrapper').show();
					$('#continue-loader-message').text("Front file is empty!");
				} 
				// else if ( imageFlag == false ) {
				// 	$('#continue-loader-wrapper').show();
				// 	$('#continue-loader-message').text("Face not found in front file!");
				// } 
				else if ( $('.stripBack').html() == "" && $("#mobileCamera").css("display") == "none" ) {
					$('#continue-loader-wrapper').show();
					$('#continue-loader-message').text("Back file is empty!");
				}
				else if ( $("#thumbnil").attr('src') == "" && $("#mobileCamera").css("display") == "block" ) {
					$('#continue-loader-wrapper').show();
					$('#continue-loader-message').text("Front file is empty!");
				} 
				else if ( $("#thumbnilBack").attr('src') == "" && $("#mobileCamera").css("display") == "block" ) {
					$('#continue-loader-wrapper').show();
					$('#continue-loader-message').text("Back file is empty!");
				}
				else {
					$('#step2-wrapper').hide()
					$('#step3-wrapper').show();
					$(".submit-btn-wrapper").show();
					$(".continue-btn-wrapper").hide();
				}
			});

			$('#submitBtn').click(function(e) {
				e.preventDefault();
				// Check environment is mobile or desktop and store this value to sessionStorage
				if ( $("#mobileCamera-step3").css("display") == "none" ) { // mobile
					sessionStorage.setItem("pageEnvironment", "desktop");
				}
				if ( $("#mobileCamera-step3").css("display") == "block" ) { // dekstop
					sessionStorage.setItem("pageEnvironment", "mobile");
				}
				if ( $('.strip-step3').html() == "" && $("#mobileCamera-step3").css("display") == "none" ) {
					$('#loader-wrapper').show();
					$('#loader-message').text("Selfie file is empty!");
				} 
				// else if ( imageFlag == false ) {
				// 	$('#loader-wrapper').show();
				// 	$('#loader-message').text("Face not found in selfie!");
				// }
				else if ( $("#thumbnil-step3").attr('src') == "" && $("#mobileCamera-step3").css("display") == "block" ) {
					$('#loader-message').show();
					$('#loader-message').text("Selfie file is empty!");
				}
				else {
					$('#fileForm').trigger('submit');
				}
			});

			// Call api
			$('#fileForm').on('submit', function(e){
				e.preventDefault();
				$('#loader-message').text('Please wait...');
				var d = new Date();

				var pageEnvironment = sessionStorage.getItem("pageEnvironment");
				if ( pageEnvironment == "mobile" ) {
					var license = $('#mySelect').val();
					// var fFile = document.getElementById("frontFile").files[0];
					var ffileSrc = $("#thumbnil").attr('src');
					if ( ffileSrc != '' ) {
						// Front file process
						ImageURL = ffileSrc;
						ext = getFileExtension(ImageURL);
						fFile = dataURLtoFile(ffileSrc, 'rp-front-'+d.getTime()+'.'+ext);				
					} 

					// var bFile = document.getElementById("backFile").files[0];
					var bFileSrc = $("#thumbnilBack").attr('src');
					if ( bFileSrc != '' ) {
						// Back file process
						ImageURL = bFileSrc;
						ext = getFileExtension(ImageURL);
						bFile = dataURLtoFile(bFileSrc, 'rp-back-'+d.getTime()+'.'+ext);
					}

					// var sFile = document.getElementById("selfiImg").files[0];
					var sFileSrc = $("#thumbnil-step3").attr('src');
					if ( sFileSrc != '' ) {
						// Selfie file process
						ImageURL = sFileSrc;
						ext = getFileExtension(ImageURL);
						sFile = dataURLtoFile(sFileSrc, 'rp-selfie-'+d.getTime()+'.'+ext);
					}

					var form = new FormData();
					form.append("Attachments", '[{"AttachmentType":"'+license+'", "AttachmentID":"'+fFile.name+'","AttachmentSourceType":"Front","HasBarCode":false},{"AttachmentType":"'+license+'", "AttachmentID":"'+bFile.name+'","AttachmentSourceType":"Back","HasBarCode":true},{"AttachmentType":"Selfie", "AttachmentID":"'+sFile.name+'","AttachmentSourceType":"Front","HasBarCode":false}]');
					form.append("frontFile", fFile);
					form.append("backFile", bFile);
					form.append("selfieFile", sFile);
				}
				else {
					var license = $('#mySelect').val();

					// Front file process
					var frontFile = sessionStorage.getItem("frontFileb64");
					ImageURL = frontFile;
					var ffile = dataURLtoFile(ImageURL, 'rp-front-'+d.getTime()+'.png');

					// Back file process
					var backFile = sessionStorage.getItem("backFileb64");
					ImageURL = backFile;
					var bfile = dataURLtoFile(ImageURL, 'rp-back-'+d.getTime()+'.png');

					// Selfie file process
					var selfieFile = sessionStorage.getItem("selfieFileb64");
					ImageURL = selfieFile;
					var sfile = dataURLtoFile(ImageURL, 'rp-selfie-'+d.getTime()+'.png');

					$('input[name="image"]').remove();

					var formReference = document.getElementById("fileForm");
					var form = new FormData(formReference);
					form.append("Attachments", '[{"AttachmentType":"'+license+'", "AttachmentID":"'+'rp-front-'+d.getTime()+'.png'+'","AttachmentSourceType":"Front","HasBarCode":false},{"AttachmentType":"'+license+'", "AttachmentID":"'+'rp-back-'+d.getTime()+'.png'+'","AttachmentSourceType":"Back","HasBarCode":true},{"AttachmentType":"Selfie", "AttachmentID":"'+'rp-selfie-'+d.getTime()+'.png'+'","AttachmentSourceType":"Front","HasBarCode":false}]');
					form.append("frontFile", ffile);
					form.append("backFile", bfile);
					form.append("selfieFile", sfile);
				}

				var settings = {
					async : true,
					"crossDomain": true,
					"url": "https://shakib.cloudapper.com/rpocrapi/api/Appointment",
					"method": "POST",
					type: "POST",
					"headers": {
						"cache-control": "no-cache",
						"postman-token": "ba0f531c-7335-2d4b-a7f6-84c282e9287f"
					},
					"processData": false,
					"contentType": false,
					cache: false,
					beforeSend: function(){
						$('#loader-wrapper').css({'visibility': 'visible'});
						$('#loader-message').text('Please wait...');
						$('#submitBtn').prop('disabled', true);	
					},
					complete: function(){
						$('#loader-wrapper').css({'visibility': 'hidden'});
						$('#submitBtn').prop('disabled', false);
					},
					success: function(){
						$('#loader-wrapper').css({'visibility': 'hidden'});
						$('#submitBtn').prop('disabled', false);
						window.location.replace("success.html");
					},
					error: function(err){
						console.log(err);
						$('#loader-message').text('Something went wrong!' + err);
						//window.location.replace("error.html");
					},
					"data": form
				}

				delete settings.headers['Content-Type'];

				$.ajax(settings).done(function(response) {
					//console.log(response);
				});
			});

			function dataURLtoFile(dataurl, filename) { 
				var arr = dataurl.split(','),
					mime = arr[0].match(/:(.*?);/)[1],
					bstr = atob(arr[1]), 
					n = bstr.length, 
					u8arr = new Uint8Array(n);
					
				while(n--){
					u8arr[n] = bstr.charCodeAt(n);
				}				
				return new File([u8arr], filename, {type:mime});
			}

			function getFileExtension(ImageURL){
				var block = ImageURL.split(";");
				var contentType = block[0].split(":")[1];
				var cBlock = contentType.split("/");
				return cBlock[1];
			}

			function _arrayBufferToBase64( buffer ) {
				var binary = '';
				var bytes = new Uint8Array( buffer );
				var len = bytes.byteLength;
				for (var i = 0; i < len; i++) {
					binary += String.fromCharCode( bytes[ i ] );
				}
				return window.btoa( binary );
			}     

			function convertCanvasToImage(canvas) {
				var image = new Image();
				image.src = canvas.toDataURL("image/png");
				return image;
			}
		});	
	</script>
</body>
</html>